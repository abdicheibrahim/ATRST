@{
    ViewData["Title"] = "Liste des projets disponibles";
}
@section Styles {
    <!-- DataTables Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
}

<div class="mb-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
        <h2 class="mb-0">Projets disponibles</h2>
    </div>
</div>

<table id="projectsTable" class="table table-striped table-bordered w-100">
    <thead class="table-success">
        <tr>
            <th style="width:72px;">Image</th>
            <th>Titre</th>
            <th>Chef de projet</th>
            <th>Date de cr√©ation</th>
            <th style="width:160px;">Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>


<!-- Modal for project request details -->
<div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" id="projectDetailsContent">
            <!-- Content will be loaded here via AJAX -->
        </div>
    </div>
</div>

<div class="modal fade" id="sendRequestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog  modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" id="sendRequestContent">
            <!-- Form will be loaded here -->
        </div>
    </div>
</div>
@section Scripts {
    <!-- DataTables Core + Bootstrap 5 Integration -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js" defer></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js" defer></script>
    @* Modal for project request details *@
    <!-- Summernote CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-lite.min.css" rel="stylesheet">

    <!-- Summernote JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-lite.min.js"></script>

    <!-- French translation (optional but recommended) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/lang/summernote-fr-FR.min.js"></script>
    <script>
        $(function () {
            // Track buttons that opened modals to improve accessibility
            let projectDetailsModalTrigger = null;
            let sendRequestModalTrigger = null;

            var table = $('#projectsTable').DataTable({
                processing: true,
                serverSide: true,
                searching: true,
                ajax: {
                    url: '@Url.Action("LoadProjects", "Project")',
                    type: 'POST'
                },
                columns: [
                    {
                        data: 'imageUrl',
                        orderable: false,
                        render: function (data, type, row) {
                            if (data) {
                                return `<img src="${data}" alt="logo"
                                            class="d-block mx-auto rounded"
                                            style="width:48px; height:48px; object-fit:cover;" />`;
                            } else {
                                const letter = (row.title || '').trim().charAt(0).toUpperCase() || 'P';
                                return `<div class="bg-dark text-white d-flex align-items-center justify-content-center mx-auto rounded"
                                            style="width:48px;height:48px;font-size:20px;">
                                            ${letter}
                                        </div>`;
                            }
                        }
                    },
                    { data: 'title', name: 'Title' },
                    { data: 'leaderFullName', name: 'LeaderFullName' },
                    {
                        data: 'creationDate',
                        name: 'CreationDate',
                        render: function (data) {
                            return data ? new Date(data).toLocaleDateString() : '';
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function (data, type, row) {
                            var detailsBtn = `<button class="btn btn-sm btn-primary btn-details me-2" data-id="${row.id}">
                                                <i class="bi bi-eye"></i> D√©tails
                                              </button>`;

                            var joinBtn = `
                                <button class="btn btn-sm btn-success btn-join"
                                        data-project-id="${row.id}"
                                        data-receiver-id="${row.leaderId}"
                                        data-type="Join">
                                    <i class="bi bi-send"></i> Rejoindre
                                </button>`;

                            return `<div class="d-flex gap-2">${detailsBtn}${joinBtn}</div>`;
                        }
                    }
                ],
                order: [[3, 'desc']],
                lengthMenu: [10, 25, 50],
                pageLength: 10,
                language: {
                    url: "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/French.json"
                }
            });

            // üìÑ Project details in modal
            $(document).on('click', '.btn-details', function (e) {
                e.preventDefault();
                var id = $(this).data('id');
                if (!id) {
                    console.error("Project ID not available");
                    return;
                }

                projectDetailsModalTrigger = this;

                $.ajax({
                    url: '@Url.Action("Details", "Project")',
                    type: 'GET',
                    data: { id: id },
                    beforeSend: function () {
                        $("#projectDetailsContent").html(`
                            <div class="text-center p-4">
                                <i class="fas fa-spinner fa-spin"></i> Chargement...
                            </div>
                        `);

                        const modalEl = document.getElementById('projectDetailsModal');
                        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                        modal.show();
                    },
                    success: function (data) {
                        $("#projectDetailsContent").html(data);
                    },
                    error: function () {
                        $("#projectDetailsContent").html(`
                            <div class="alert alert-danger m-3">Erreur lors du chargement des d√©tails.</div>
                        `);
                    }
                });
            });

                    // ‚úâÔ∏è Send join request (open modal)
        $(document).on("click", ".btn-join", function () {
            var projectId = $(this).data("project-id");
            var receiverId = $(this).data("receiver-id");
            var type = $(this).data("type");

            if (!projectId || !receiverId) {
                console.error("Project or receiver data not available");
                return;
            }

            sendRequestModalTrigger = this;

            $.ajax({
                url: '@Url.Action("Send", "ProjectRequest")',
                type: 'GET',
                 data:{ projectId: projectId, receiverId: receiverId, type: type },
                beforeSend: function () {
                    $("#sendRequestContent").html(`
                        <div class="text-center p-4">
                            <i class="fas fa-spinner fa-spin"></i> Chargement du formulaire...
                        </div>
                    `);

                    const modalEl = document.getElementById('sendRequestModal');
                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                    modal.show();
                },
                success: function (data) {
                    $("#sendRequestContent").html(data);
                    initializeProjectRequestDetails(); // ‚Üê Summernote is initialized here
                },
                error: function () {
                    $("#sendRequestContent").html(`
                        <div class="alert alert-danger m-3">Erreur lors du chargement du formulaire.</div>
                    `);
                }
            });
        });

        // ‚úÖ Initialize Summernote after content loading
        function initializeProjectRequestDetails() {
            const $textarea = $('#sendRequestContent').find('textarea.Description');
            if ($textarea.length) {
                $textarea.summernote({
                    height: 250,
                    lang: 'fr-FR',
                    toolbar: [
                        ['style', ['bold', 'italic', 'underline']],
                        ['font', ['strikethrough']],
                        ['para', ['ul', 'ol']],
                        ['insert', ['link']],
                        ['view', ['fullscreen', 'codeview']]
                    ],
                    placeholder: '√âcrivez votre message ici...',
                    callbacks: {
                        onInit: function () {
                            console.log('‚úÖ Summernote initialized.');
                        }
                    }
                });
            } else {
                console.warn('‚ö†Ô∏è Textarea with class "Description" not found.');
            }
        }

        // üßπ Destroy Summernote when closing modal
        $('#sendRequestModal').on('hidden.bs.modal', function () {
            const $textarea = $('#sendRequestContent').find('textarea.Description');
            if ($textarea.length && $textarea.summernote) {
                $textarea.summernote('destroy');
                console.log('üßπ Summernote destroyed.');
            }

            $('#sendRequestContent').empty();
            sendRequestModalTrigger = null;
        });
            // üîÑ Handle closing project details modal
            $('#projectDetailsModal').on('hidden.bs.modal', function () {
                $('#projectDetailsContent').empty(); // Clear content
                if (projectDetailsModalTrigger) {
                    setTimeout(() => {
                        projectDetailsModalTrigger.focus();
                        projectDetailsModalTrigger = null;
                    }, 50);
                }
            });

            // üîÑ Handle closing send request modal
            $('#sendRequestModal').on('hidden.bs.modal', function () {
                $('#sendRequestContent').empty(); // Clear content
                if (sendRequestModalTrigger) {
                    setTimeout(() => {
                        sendRequestModalTrigger.focus();
                        sendRequestModalTrigger = null;
                    }, 50);
                }
            });

            // ‚úÖ Close modal via internal buttons (btn-close or close button)
            $(document).on('click', '[data-bs-dismiss="modal"], .btn-close', function () {
                const modalEl = $(this).closest('.modal')[0];
                if (!modalEl) return;

                const modal = bootstrap.Modal.getInstance(modalEl);
                if (!modal) return;

                // Determine which button opened the modal
                let triggerButton = null;
                if (modalEl.id === 'projectDetailsModal') {
                    triggerButton = projectDetailsModalTrigger;
                } else if (modalEl.id === 'sendRequestModal') {
                    triggerButton = sendRequestModalTrigger;
                }

                // Close modal first
                modal.hide();

                // Then refocus after closing
                if (triggerButton) {
                    setTimeout(() => {
                        triggerButton.focus();
                    }, 100); // 100ms to ensure complete closure
                }
            });

        });
    </script>
}