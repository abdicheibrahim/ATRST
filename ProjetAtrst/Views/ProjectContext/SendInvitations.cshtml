@using ProjetAtrst.ViewModels.Researcher
@model SendInvitationViewModel
@{
    Layout = "_LayoutProject";
}

<h2>Liste des utilisateurs disponibles</h2>

<div class="table-responsive">
    <table id="usersTable" class="table table-bordered table-striped w-100">
        <thead>
            <tr>
                <th>L'image</th>
                <th>Nom et Prénom</th>
                <th>role</th>
                <th>Procédures</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- 📦 Modal لإرسال الدعوة -->
<div class="modal fade" id="sendInvitationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" id="sendInvitationContent">
            <!-- سيتم تحميل الفورم هنا عبر AJAX -->
        </div>
    </div>
</div>

@section Scripts {
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <!-- Summernote (اختياري للرسالة) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-lite.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-lite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/lang/summernote-fr-FR.min.js"></script>

    <script>
        const CURRENT_PROJECT_ID = @Model.CurrentProjectId;
        let sendInvitationModalTrigger = null;

        $(document).ready(function() {
            var table = $('#usersTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '/ProjectContext/SendInvitations',
                    type: 'GET'
                },
                columns: [
                    {
                        data: "profilePicturePath",
                        render: function(data) {
                            return `<img src="${data}" style="height:50px; width:50px; object-fit:cover; border-radius:6px;" />`;
                        },
                        orderable: false
                    },
                    { data: "fullName" },
                    { data: "gender" },
                    {
                        data: "id",
                        render: function(data) {
                            return `<button class="btn btn-outline-primary btn-sm btn-invite"
                                             data-receiver-id="${data}">
                                        <i class="bi bi-send"></i> Inviter
                                    </button>`;
                        },
                        orderable: false
                    }
                ],
                // language: {
                //     url: "cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/French.json"
                // },
                pageLength: 10,
                responsive: true,
                searching: true,
                ordering: true
            });

            // ✉️ فتح مودال إرسال الدعوة
            $(document).on("click", ".btn-invite", function () {
                var receiverId = $(this).data("receiver-id");
                if (!receiverId) {
                    console.error("معرف المستلم غير متوفر");
                    return;
                }

                sendInvitationModalTrigger = this;

                $.ajax({
                    url: '@Url.Action("Send", "ProjectRequest")',
                    type: 'GET',
                    data: { projectId: CURRENT_PROJECT_ID, receiverId: receiverId, type: "Invitation" },
                    beforeSend: function () {
                        $("#sendInvitationContent").html(`
                            <div class="text-center p-4">
                                <i class="fas fa-spinner fa-spin"></i> Chargement du formulaire...
                            </div>
                        `);

                        const modalEl = document.getElementById('sendInvitationModal');
                        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                        modal.show();
                    },
                    success: function (data) {
                        $("#sendInvitationContent").html(data);
                        initializeInvitationForm(); // تهيئة Summernote إذا فيه textarea
                    },
                    error: function () {
                        $("#sendInvitationContent").html(`
                            <div class="alert alert-danger m-3">Erreur lors du chargement du formulaire.</div>
                        `);
                    }
                });
            });

            // ✅ تهيئة Summernote داخل المودال
            function initializeInvitationForm() {
                const $textarea = $('#sendInvitationContent').find('textarea.Description');
                if ($textarea.length) {
                    $textarea.summernote({
                        height: 200,
                        lang: 'fr-FR',
                        toolbar: [
                            ['style', ['bold', 'italic', 'underline']],
                            ['para', ['ul', 'ol']],
                            ['insert', ['link']],
                            ['view', ['fullscreen', 'codeview']]
                        ],
                        placeholder: 'Écrivez votre message ici...'
                    });
                }
            }

            // 🧹 تنظيف المودال عند الإغلاق
            $('#sendInvitationModal').on('hidden.bs.modal', function () {
                const $textarea = $('#sendInvitationContent').find('textarea.Description');
                if ($textarea.length && $textarea.summernote) {
                    $textarea.summernote('destroy');
                }
                $('#sendInvitationContent').empty();
                if (sendInvitationModalTrigger) {
                    setTimeout(() => {
                        sendInvitationModalTrigger.focus();
                        sendInvitationModalTrigger = null;
                    }, 50);
                }
            });
        });
    </script>
}
