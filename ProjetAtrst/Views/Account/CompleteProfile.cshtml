@using ProjetAtrst.ViewModels.Account
@model CompleteProfileViewModel

@{
    Layout = "_LayoutResearcher";
    ViewData["Title"] = "Profil";
}

@if (Model.IsCompleted)
{
    <div class="alert alert-success text-center alert-dismissible fade show" role="alert">
        Votre profil est<strong> complet.</strong> Vous pouvez le modifier ici.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
else
{
    <div class="alert alert-warning text-center">
        Veuillez compléter les informations ci-dessous pour activer votre compte.
    </div>
}
@section Styles{
    <link href="~/css/showsuccesserrormodal.css" rel="stylesheet" />
}
@await Html.PartialAsync("~/Views/Shared/Popup/_SuccessModal.cshtml")
@await Html.PartialAsync("~/Views/Shared/Popup/_ErrorModal.cshtml")
@await Html.PartialAsync("~/Views/Shared/Popup/_ModalScripts.cshtml")

@* @await Html.PartialAsync("_SuccessToast") *@

<form asp-action="CompleteProfile" method="post">
    <div class="row shadow-sm g-3 needs-validation p-3 mb-5 mt-3 bg-white border rounded">
        <h5>Informations personnelles</h5>

        <div class="col-md-6">
            <label asp-for="FirstName" class="form-label">Prénom</label>
            <input type="text" class="form-control input" asp-for="FirstName" placeholder="Entrez votre prénom">
            <span asp-validation-for="FirstName"></span>
        </div>

        <div class="col-md-6">
            <label asp-for="LastName" class="form-label">Nom</label>
            <input type="text" class="form-control input" asp-for="LastName" placeholder="Entrez votre nom">
            <span asp-validation-for="LastName"></span>
        </div>

        <div class="col-md-6">
            <label asp-for="FirstNameAr" class="form-label">Prénom (arabe)</label>
            <input type="text" class="form-control input" asp-for="FirstNameAr" placeholder="أدخل الاسم">
            <span asp-validation-for="FirstNameAr"></span>
        </div>

        <div class="col-md-6">
            <label asp-for="LastNameAr" class="form-label">Nom (arabe)</label>
            <input type="text" class="form-control input" asp-for="LastNameAr" placeholder="أدخل اللقب">
            <span asp-validation-for="LastNameAr"></span>
        </div>

        <div class="col-md-6">
            <label asp-for="Gender" class="form-label">Genre</label>
            <select class="form-control input" asp-for="Gender">
                <option value="">-- Sélectionnez le genre --</option>
                <option value="Homme">Homme</option>
                <option value="Femme">Femme</option>
            </select>
            <span asp-validation-for="Gender"></span>
        </div>
        <div class="col-md-6">
            <label asp-for="Birthday" class="form-label">Date de naissance</label>
            <input type="date" class="form-control input" asp-for="Birthday" placeholder="JJ/MM/AAAA">
            <span asp-validation-for="Birthday"></span>
        </div>
    </div>

    <div class="row shadow-sm g-3 needs-validation p-3 mb-5 mt-3 bg-white border rounded">
        <h5>Détails professionnels</h5>

        <div class="col-md-6">
            <label asp-for="Establishment" class="form-label">Établissement</label>
            <select asp-for="Establishment" asp-items="Model.EstablishmentsList" class="form-select" id="establishmentSelect"></select>
            <span asp-validation-for="Establishment" class="text-danger"></span>
            <input type="text" id="customEstablishment" name="Establishment" class="form-control mt-2 d-none" placeholder="Entrez le nom de l'établissement manuellement" />
        </div>

        <div class="col-md-6">
            <label asp-for="Grade" class="form-label">Grade</label>
            <select asp-for="Grade" asp-items="Model.GradesList" class="form-select" id="gradeSelect"></select>
            <span asp-validation-for="Grade" class="text-danger"></span>
            <input type="text" id="customGrade" name="Grade" class="form-control mt-2 d-none" placeholder="Entrez le grade manuellement" />
        </div>

        <div class="col-md-6">
            <label asp-for="Statut" class="form-label">Statut</label>
            <select asp-for="Statut" asp-items="Model.StatutList" class="form-select" id="statutSelect"></select>
            <span asp-validation-for="Statut" class="text-danger"></span>
            <input type="text" id="customStatut" name="Statut" class="form-control mt-2 d-none" placeholder="Entrez le statut manuellement" />
        </div>

        <div class="col-md-6">
            <label asp-for="Speciality" class="form-label">Spécialité</label>
            <input type="text" class="form-control input" asp-for="Speciality">
            <span asp-validation-for="Speciality"></span>
        </div>

        <div class="col-md-6">
            <label asp-for="Mobile" class="form-label">Téléphone mobile</label>
            <input type="text" class="form-control input" asp-for="Mobile">
            <span asp-validation-for="Mobile"></span>
        </div>

        <div class="col-md-6">
            <label asp-for="Diploma" class="form-label">Diplôme</label>
            <input type="text" class="form-control input" asp-for="Diploma">
            <span asp-validation-for="Diploma"></span>
        </div>

        <div class="col-md-6">
            <label asp-for="DipInstitution" class="form-label">Établissement du diplôme</label>
            <input type="text" class="form-control input" asp-for="DipInstitution">
            <span asp-validation-for="DipInstitution"></span>
        </div>

        <div class="col-md-6">
            <label asp-for="DipDate" class="form-label">Date d'obtention</label>
            <input type="date" class="form-control input" asp-for="DipDate">
            <span asp-validation-for="DipDate"></span>
        </div>
        <div class="row shadow-sm g-3 needs-validation p-3 mb-5 mt-3 bg-white border rounded">
            <h5>Contribution sociale/économique (facultatif)</h5>

            <div class="col-md-12">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="partnerToggle" asp-for="WantsToContributeAsPartner" />
                    <label class="form-check-label" for="partnerToggle">
                        @Html.DisplayNameFor(m => m.WantsToContributeAsPartner)
                    </label>
                </div>
            </div>

            <div class="col-md-12" id="partnerContribution" style="display: none;">
                <label asp-for="SocioEconomicContributions" class="form-label"></label>
                <textarea asp-for="SocioEconomicContributions" class="form-control" rows="4" placeholder="Décrivez ici vos contributions sociales ou économiques..."></textarea>
                <span asp-validation-for="SocioEconomicContributions" class="text-danger"></span>
            </div>
        </div>

    </div>

    <button type="submit" id="submitBtn" class="btn btn-success w-100">
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="spinner"></span>
        <span id="btnText">Enregistrer</span>
    </button>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="~/js/Spinner.js"></script>

    <script>
        function normalizeString(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        function customMatcher(params, data) {
            if ($.trim(params.term) === '') return data;
            const term = normalizeString(params.term);
            const text = normalizeString(data.text);
            return text.includes(term) ? data : null;
        }

        $(document).ready(function () {
            function applySelect2(selector) {
                $(selector).select2({
                    theme: 'bootstrap-5',
                    width: '100%',
                    matcher: customMatcher
                });

                $(selector).on('select2:open', function () {
                    setTimeout(function () {
                        document.querySelector('.select2-container--open .select2-search__field').focus();
                    }, 0);
                });
            }

            applySelect2('#establishmentSelect');
            applySelect2('#gradeSelect');
            applySelect2('#statutSelect');

            function toggleCustomInput(selectId, inputId) {
                const selectedValue = $(`#${selectId}`).val();
                if (selectedValue === 'Autre' || selectedValue === 'Other') {
                    $(`#${inputId}`).removeClass('d-none').attr("required", "required");
                } else {
                    $(`#${inputId}`).addClass('d-none').removeAttr("required");
                }
            }

            $('#establishmentSelect').on('change', function () {
                toggleCustomInput('establishmentSelect', 'customEstablishment');
            });

            $('#gradeSelect').on('change', function () {
                toggleCustomInput('gradeSelect', 'customGrade');
            });

            $('#statutSelect').on('change', function () {
                toggleCustomInput('statutSelect', 'customStatut');
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const arabicOnly = /^[\u0621-\u064A\s]+$/;

            const firstNameArInput = document.getElementById("FirstNameAr");
            const lastNameArInput = document.getElementById("LastNameAr");

            function validateArabicInput(inputElement) {
                const value = inputElement.value.trim();
                const validationMessage = inputElement.nextElementSibling;

                if (value.length > 0 && !arabicOnly.test(value)) {
                    validationMessage.textContent = " يُسمح فقط بالحروف العربية والمسافات.";
                    inputElement.classList.add("is-invalid");
                } else {
                    validationMessage.textContent = "";
                    inputElement.classList.remove("is-invalid");
                }
            }

            firstNameArInput?.addEventListener("input", function () {
                validateArabicInput(firstNameArInput);
            });

            lastNameArInput?.addEventListener("input", function () {
                validateArabicInput(lastNameArInput);
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const checkbox = document.getElementById("partnerToggle");
            const contributionDiv = document.getElementById("partnerContribution");

            function toggleContributionField() {
                if (checkbox.checked) {
                    contributionDiv.style.display = "block";
                } else {
                    contributionDiv.style.display = "none";
                }
            }

            checkbox.addEventListener("change", toggleContributionField);

            // Show if already checked (important when returning with validation errors)
            toggleContributionField();
        });
    </script>

    
}
