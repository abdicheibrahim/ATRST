@model IEnumerable<ProjectRequest>
@{
    ViewData["Title"] = "Demandes/Invitations envoyées 📤";

}

<div class="mb-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
        <h2 class="mb-0">Requêtes envoyées 📤</h2>
        <div class="d-flex flex-column flex-sm-row gap-2">
            <a class="btn btn-outline-success" asp-controller="Project" asp-action="AvailableProjects">
                <i class="bi bi-person-plus"></i> Rejoindre un projet
            </a>
        </div>
    </div>
</div>
<div class="mb-3">
    <button class="btn btn-outline-success status-filter" data-status="all">Tous</button>
    <button class="btn btn-outline-success status-filter" data-status="pending">Suspendu</button>
    <button class="btn btn-outline-success status-filter" data-status="accepted">Accepté</button>
    <button class="btn btn-outline-success status-filter" data-status="rejected">Rejeté</button>
</div>
<div class="table-responsive">
    <table id="requestsTable" class="table table-bordered table-striped align-middle shadow-sm text-al">
        <thead class="table-success">
            <tr>
                <th>Destinataire</th>
                <th>Projet</th>
                <th>Statut</th>
                <th>Date d'envoi</th>
                <th>Options</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var req in Model)
            {
                <tr>
                    <td>@req.Receiver?.FullName</td>
                    <td>@req.Project?.Title</td>
                    <td>
                        @switch (req.Status)
                        {
                            case RequestStatus.Pending:
                                <span class="badge bg-warning text-dark status-badge" data-status="pending"><i class="bi bi-hourglass-split me-1"></i>Suspendu</span>
                                break;
                            case RequestStatus.Accepted:
                                <span class="badge bg-success status-badge" data-status="accepted"><i class="bi bi-check-circle me-1"></i>Accepté</span>
                                break;
                            case RequestStatus.Rejected:
                                <span class="badge bg-danger status-badge" data-status="rejected"><i class="bi bi-x-circle me-1"></i>Rejeté</span>
                                break;
                        }
                    </td>
                    <td data-sort="@req.CreatedAt.DayNumber">@req.CreatedAt.ToString("yyyy-MM-dd")</td>
                    <td>
                        <div class="d-flex gap-1">
                            <button type="button"
                                    class="btn btn-outline-primary btn-sm"
                                    title="Détails"
                                    onclick="loadProjectRequestDetails('@req.Id', this)">
                                <i class="bi bi-eye"></i>
                            </button>
                            @if (req.Status == RequestStatus.Pending)
                            {
                                <form asp-controller="ProjectRequest" asp-action="Cancel" asp-route-id="@req.Id" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Cancel">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </form>
                            }
                           
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
<!-- Modal لتفاصيل طلب المشروع -->
<div class="modal fade" id="projectRequestDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" id="projectRequestDetailsContent">
            <!-- سيتم تحميل المحتوى هنا عبر AJAX -->
        </div>
    </div>
</div>
@section scripts {
    <!-- إضافة مكتبات DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="~/js/datatablesincsr.js"></script>
        @* Modal لتفاصيل طلب المشروع *@
    <!-- Summernote CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-lite.min.css  " rel="stylesheet">

    <!-- Summernote JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-lite.min.js  "></script>

    <script>
        $(function () {
            // تتبع الزر الذي فتح المودال
            let projectRequestDetailsModalTrigger = null;

            // تحميل تفاصيل طلب المشروع داخل المودال
            window.loadProjectRequestDetails = function (requestId, triggerButton = null) {
                if (!requestId) {
                    console.error("معرف طلب المشروع غير متوفر");
                    return;
                }

                // حفظ الزر الذي فتح المودال
                projectRequestDetailsModalTrigger = triggerButton;

                $.ajax({
                    url: '@Url.Action("Details", "ProjectRequest")',
                    type: 'GET',
                    data: { id: requestId }, // تأكد أن اسم الباراميتر مطابق للـ Action
                    beforeSend: function () {
                        $("#projectRequestDetailsContent").html(`
                            <div class="text-center p-4">
                                <i class="fas fa-spinner fa-spin"></i> جاري التحميل...
                            </div>
                        `);

                        const modalEl = document.getElementById('projectRequestDetailsModal');
                        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                        modal.show();
                    },
                    success: function (data) {
                        $("#projectRequestDetailsContent").html(data);
                         initializeProjectRequestDetails();
                    },
                    error: function (xhr) {
                        const errorMessage = xhr.status === 404
                            ? "تفاصيل الطلب غير متوفرة"
                            : "حدث خطأ أثناء تحميل التفاصيل";

                        $("#projectRequestDetailsContent").html(`
                            <div class="alert alert-danger m-3">${errorMessage}</div>
                        `);

                        const modalEl = document.getElementById('projectRequestDetailsModal');
                        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                        modal.show();
                    }
                });
            };

            // تهيئة إضافية بعد تحميل التفاصيل (اختياري)
            function initializeProjectRequestDetails() {
                 $(document).ready(function () {
            $('.Description').summernote({
                height: 300,
                lang: 'fr-FR',
              
            });
        });
            }

            // عند إغلاق المودال
            $('#projectRequestDetailsModal').on('hidden.bs.modal', function () {
                // تنظيف المحتوى
                $('#projectRequestDetailsContent').empty();

                // إعادة التركيز للزر
                if (projectRequestDetailsModalTrigger) {
                    setTimeout(() => {
                        projectRequestDetailsModalTrigger.focus();
                        projectRequestDetailsModalTrigger = null;
                    }, 50);
                }
            });

        });
    </script>

    
    

}
